<?php
$escape = $this->plugin('escapeHtml');
$translate = $this->plugin('translate');
$resource = $this->resource ?? null;
if (!$resource || !method_exists($resource, 'id')) {
  return;
}

// JSON-LD API URL (relative path)
$jsonLdUrl = '';
try {
  $jsonLdUrl = $this->url('api/default', [
    'resource' => $resource->resourceName(),
    'id' => $resource->id(),
  ], ['force_canonical' => false]);
} catch (\Throwable $e) {
  $jsonLdUrl = '';
}

// IIIF Manifest for items only
$manifestUrl = '';
$siteManifestProp = trim((string) $this->siteSetting('zipdownload_export_manifest_property'));
if ($siteManifestProp === '') { $siteManifestProp = trim((string) $this->siteSetting('zipdownload.export_manifest_property')); }
try {
  if (method_exists($resource, 'resourceName') && $resource->resourceName() === 'items') {
    $ver = (string) $this->setting('iiifserver_manifest_default_version', '3');
    $ver = in_array($ver, ['2', '3'], true) ? $ver : '3';
    $manifestUrl = '/iiif/' . $ver . '/' . (int) $resource->id() . '/manifest';
    // If a site setting for manifest property is set, try to override.
    if ($siteManifestProp !== '') {
      try {
        // Property is like prefix:term.
        $prop = $siteManifestProp;
        $value = '';
        if (method_exists($resource, 'value')) {
          $valObj = $resource->value($prop, ['type' => 'uri']);
          if (!$valObj) { $valObj = $resource->value($prop, ['type' => 'literal']); }
          if ($valObj) { $value = (string) $valObj; }
        }
        if ($value !== '') { $manifestUrl = $value; }
      } catch (\Throwable $e) { /* ignore */ }
    }
  }
} catch (\Throwable $e) {
  $manifestUrl = '';
}

if (!$jsonLdUrl && !$manifestUrl) {
  // Nothing to show.
  return;
}
// Title from Site Settings, fallback to translated default.
$lang = $this->lang();
$isJa = (strpos((string) $lang, 'ja') === 0);
$exportTitle = trim((string) ($isJa
  ? $this->siteSetting('zipdownload_export_block_title_ja')
  : $this->siteSetting('zipdownload_export_block_title_en')));
if ($exportTitle === '') { $exportTitle = trim((string) $this->siteSetting('zipdownload_export_block_title')); }
if ($exportTitle === '') { $exportTitle = trim((string) $this->siteSetting('zipdownload.export_block_title')); }
if ($exportTitle === '') { $exportTitle = $isJa ? 'エクスポート' : (string) $translate('Export'); }

// Optional icons from Site Settings.
$iconIiif = trim((string) $this->siteSetting('zipdownload_export_icon_iiif_url'));
if ($iconIiif === '') { $iconIiif = trim((string) $this->siteSetting('zipdownload.export_icon_iiif_url')); }
if ($iconIiif === '') { $iconIiif = 'https://avatars3.githubusercontent.com/u/5812589?v=3&s=48'; }
$iconJsonld = trim((string) $this->siteSetting('zipdownload_export_icon_jsonld_url'));
if ($iconJsonld === '') { $iconJsonld = trim((string) $this->siteSetting('zipdownload.export_icon_jsonld_url')); }
if ($iconJsonld === '') { $iconJsonld = 'https://json-ld.org/images/json-ld-logo-64.png'; }
?>
<div class="panel">
  <h3><?php echo $escape($exportTitle); ?></h3>
  <ul>
    <?php if ($manifestUrl): ?>
      <li>
        <a href="<?php echo $escape($manifestUrl); ?>" target="_blank" rel="noopener">
          <?php if ($iconIiif): ?><img src="<?php echo $escape($iconIiif); ?>" alt="IIIF" width="24" height="24" /><?php endif; ?>
          <span>IIIF Manifest</span>
        </a>
      </li>
    <?php endif; ?>
    <?php if ($jsonLdUrl): ?>
      <li>
        <a href="<?php echo $escape($jsonLdUrl); ?>" target="_blank" rel="noopener">
          <?php if ($iconJsonld): ?><img src="<?php echo $escape($iconJsonld); ?>" alt="JSON-LD" width="24" height="24" /><?php endif; ?>
          <span>JSON-LD</span>
        </a>
      </li>
    <?php endif; ?>
  </ul>
</div>
